#!/bin/bash

set -e

proj_name="$(basename "${PWD}")"

mkdir -p ~/.vibe
if ! [ -e ~/.vibe/config.toml ]; then
    touch ~/.vibe/config.toml
fi

if ! podman image exists mistral-vibe:latest; then
    "$(dirname "${0}")/build.sh"
fi

# Create directory for additional git config if it doesn't exist
mkdir -p ~/.config/git

# Build gitconfig mount args (only if file exists)
gitconfig_args=()
if [ -f ~/.gitconfig ]; then
    gitconfig_args+=(-v ~/.gitconfig:/home/vibe/.gitconfig:ro,z)
fi

# Handle MISTRAL_API_KEY as podman secret
if [ -n "${MISTRAL_API_KEY}" ]; then
    if ! podman secret exists mistral-api-key; then
        echo "Creating podman secret for MISTRAL_API_KEY"
        echo -n "${MISTRAL_API_KEY}" | podman secret create mistral-api-key -
    fi
    secret_args+=(--secret mistral-api-key,type=env,target=MISTRAL_API_KEY)
elif podman secret exists mistral-api-key; then
    # Use existing secret even if env var is not set
    secret_args+=(--secret mistral-api-key,type=env,target=MISTRAL_API_KEY)
fi

# Handle GH_TOKEN as podman secret
if [ -n "${GH_TOKEN}" ]; then
    if ! podman secret exists mistral-github-token; then
        echo "Creating podman secret for GH_TOKEN"
        echo -n "${GH_TOKEN}" | podman secret create mistral-github-token -
    fi
    secret_args+=(--secret mistral-github-token,type=env,target=GH_TOKEN)
elif podman secret exists mistral-github-token; then
    # Use existing secret even if env var is not set
    secret_args+=(--secret mistral-github-token,type=env,target=GH_TOKEN)
fi

# Set default agent to auto-approve if not specified
if [[ ! "$*" == *--agent* ]]; then
    set -- "$@" --agent auto-approve
fi

exec podman run -i -t --tz=local \
    --name="mistral-vibe-${proj_name}" --rm \
    --userns=keep-id \
    --network=host \
    --security-opt 'unmask=/proc/*' \
    --security-opt label=type:container_userns_t \
    --mount type=tmpfs,destination=/tmp/vibe \
    -v "${PWD}:/projects/${proj_name}:z" \
    -w "/projects/${proj_name}" \
    "${gitconfig_args[@]}" \
    -v ~/.config/git:/home/vibe/.config/git:ro,z \
    -v ~/.vibe:/home/vibe/.vibe:z \
    "${secret_args[@]}" \
    localhost/mistral-vibe:latest "$@"
